name: 🤖 Auto Update Dependencies

on:
  schedule:
    # Executa toda segunda-feira às 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite execução manual

jobs:
  update-dependencies:
    name: 📦 Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pip-tools
        run: pip install pip-tools

      - name: Update requirements
        run: |
          # Gerar requirements.txt atualizado
          pip-compile --upgrade requirements.in || pip-compile --upgrade --resolver=backtracking requirements.in
          
          # Se não existe requirements.in, usar requirements.txt atual
          if [ ! -f requirements.in ]; then
            cp requirements.txt requirements.in
            pip-compile --upgrade requirements.in
          fi

      - name: Check for changes
        id: changes
        run: |
          if git diff --exit-code requirements.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🔄 Auto-update Python dependencies"
          title: "🔄 Automated dependency updates"
          body: |
            ## 🤖 Automated Dependency Update
            
            This PR updates Python dependencies to their latest compatible versions.
            
            ### 📋 Changes
            - Updated `requirements.txt` with latest dependency versions
            - All updates maintain backward compatibility based on version constraints
            
            ### ✅ Validation
            - [ ] All tests pass
            - [ ] Docker build succeeds
            - [ ] No breaking changes detected
            
            ### 🔍 Review Guidelines
            1. Check for any breaking changes in updated packages
            2. Verify test coverage remains adequate
            3. Test critical scraping functionality
            
            **Note**: This PR was created automatically by GitHub Actions.
          branch: auto-update-dependencies
          delete-branch: true
          labels: |
            dependencies
            automated
            python

  update-docker-base:
    name: 🐳 Check Docker Base Image Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Python base image updates
        id: docker-check
        run: |
          # Verificar se há uma versão mais recente do Python 3.11
          current_version=$(grep "FROM python:" Dockerfile | head -1 | cut -d: -f2 | cut -d- -f1)
          echo "Current Python version: $current_version"
          
          # Aqui você poderia adicionar lógica para verificar versões mais recentes
          # Por enquanto, apenas registrar informação
          echo "python-version=$current_version" >> $GITHUB_OUTPUT

      - name: Create issue for manual review
        if: false # Desabilitado por enquanto, habilite quando necessário
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🐳 Docker Base Image Update Available',
              body: `
                ## Docker Base Image Update Check
                
                Current Python version in Dockerfile: ${{ steps.docker-check.outputs.python-version }}
                
                Please manually verify if a newer Python 3.11.x version is available and update if appropriate.
                
                ### Steps to Update:
                1. Check [Python Docker Hub](https://hub.docker.com/_/python) for latest 3.11 tags
                2. Update Dockerfile if newer version available
                3. Test build and functionality
                4. Create PR with changes
                
                This issue was created automatically by GitHub Actions.
              `,
              labels: ['docker', 'maintenance', 'automated']
            })

  security-audit:
    name: 🔒 Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Safety check
        continue-on-error: true
        run: |
          safety check --json --output safety-report.json || true
          
      - name: Run pip-audit
        continue-on-error: true
        run: |
          pip-audit --format=json --output=pip-audit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-reports
          path: |
            safety-report.json
            pip-audit-report.json

      - name: Process security findings
        run: |
          # Processar relatórios e criar issues se vulnerabilidades críticas forem encontradas
          if [ -f safety-report.json ]; then
            # Verificar se há vulnerabilidades
            vulns=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
            if [ "$vulns" -gt 0 ]; then
              echo "⚠️ $vulns vulnerabilities found by Safety"
            fi
          fi
          
          if [ -f pip-audit-report.json ]; then
            # Verificar vulnerabilidades do pip-audit
            echo "📋 Pip-audit report generated"
          fi